#CTE QUERY TO CALCULATE THE AVERAGE AMOUNT PAID BY TOP 5 CUSTOMERS
WITH top_5_customers AS (
    SELECT 
        customer.customer_id,
        customer.first_name,
        customer.last_name,
        ctry.country,
        cty.city,
        SUM(pay.amount) AS total_amount_paid
    FROM 
        customer
    INNER JOIN payment AS pay ON customer.customer_id = pay.customer_id
    INNER JOIN address AS addr ON customer.address_id = addr.address_id
    INNER JOIN city AS cty ON addr.city_id = cty.city_id
    INNER JOIN country AS ctry ON cty.country_id = ctry.country_id
    WHERE 
        cty.city IN (
            'Aurora','Atlixco','Xintai','Adoni','Dhule (Dhulia)',
            'Kurashiki','Pingxiang','Sivas','Celaya','So Leopoldo'
        ) 
        AND ctry.country IN (
            'India','China','United States','Japan','Mexico','Brazil',
            'Russian Federation','Philippines','Turkey','Indonesia'
        )
    GROUP BY 
        customer.customer_id, customer.first_name, customer.last_name, ctry.country, cty.city
    ORDER BY 
        total_amount_paid DESC
    LIMIT 5
)
SELECT 
    AVG(total_amount_paid) AS average_amount_paid
FROM 
    top_5_customers;




#CTE QUERY OF 5 TOP CUSTOMERS THAT ARE BASED IN EACH COUNTRY
WITH top_5_customers AS (
    SELECT 
        customer.customer_id,
        ctry.country
    FROM 
        customer
    INNER JOIN payment AS pay ON customer.customer_id = pay.customer_id
    INNER JOIN address AS addr ON customer.address_id = addr.address_id
    INNER JOIN city AS cty ON addr.city_id = cty.city_id
    INNER JOIN country AS ctry ON cty.country_id = ctry.country_id
    WHERE 
        cty.city IN (
            'Aurora','Atlixco','Xintai','Adoni','Dhule (Dhulia)',
            'Kurashiki','Pingxiang','Sivas','Celaya','So Leopoldo'
        ) 
        AND ctry.country IN (
            'India','China','United States','Japan','Mexico','Brazil',
            'Russian Federation','Philippines','Turkey','Indonesia'
        )
    GROUP BY 
        customer.customer_id, ctry.country
    ORDER BY 
        SUM(pay.amount) DESC
    LIMIT 5
)
SELECT 
    ctry1.country,
    COUNT(DISTINCT customer.customer_id) AS all_customer_count,
    COUNT(DISTINCT top_5_customers.customer_id) AS top_customer_count
FROM 
    customer
INNER JOIN address AS addr1 ON customer.address_id = addr1.address_id
INNER JOIN city AS cty1 ON addr1.city_id = cty1.city_id
INNER JOIN country AS ctry1 ON cty1.country_id = ctry1.country_id
LEFT JOIN top_5_customers ON ctry1.country = top_5_customers.country
GROUP BY 
    ctry1.country
ORDER BY 
    all_customer_count DESC
LIMIT 5;
